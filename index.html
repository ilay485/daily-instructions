<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>הוראות יומיות</title>
<style>
  body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(to bottom, #f7f9fc, #ffffff); margin:0; padding:0; text-align:center; direction:rtl; }
  header { background:#1db954; color:white; padding:20px 10px; font-size:24px; font-weight:bold; box-shadow:0 4px 12px rgba(0,0,0,0.15); position:sticky; top:0; z-index:100; }
  .card { margin:30px auto; padding:25px; width:90%; max-width:420px; background:white; border-radius:16px; box-shadow:0 6px 16px rgba(0,0,0,0.1); position:relative; }
  input, textarea { width:100%; padding:14px; margin:10px 0; font-size:16px; border-radius:12px; border:1px solid #ccc; text-align:right; box-sizing:border-box; }
  textarea { resize:vertical; min-height:80px; }
  button { width:100%; padding:14px; margin:10px 0; font-size:16px; border:none; border-radius:12px; background:#1db954; color:white; font-weight:bold; cursor:pointer; transition:0.3s ease; }
  button:hover { background:#17a74a; transform:scale(1.03); }
  #logout { background:#f44336; }
  #logout:hover { background:#d32f2f; }
  #adminPanel { background:#e8f5e9; }
  h2 { color:#1db954; margin-bottom:10px; font-size:22px; }
  .message { padding:10px; margin:10px 0; border-radius:12px; font-weight:bold; display:none; }
  .error { background:#fdd; color:#900; }
  .success { background:#dfd; color:#070; }
  @media(max-width:480px){ header{font-size:22px;} .card{width:94%; padding:20px;} }
  /* Modal */
  .modal { display:none; position:fixed; z-index:200; left:0; top:0; width:100%; height:100%; overflow:auto; background-color:rgba(0,0,0,0.5); }
  .modal-content { background:white; margin:10% auto; padding:20px; border-radius:16px; width:90%; max-width:400px; text-align:right; position:relative; }
  .close { position:absolute; right:15px; top:10px; font-size:24px; font-weight:bold; cursor:pointer; color:#555; }
  .loading { font-style:italic; color:#999; }
</style>
</head>
<body>

<header>הוראות יומיות</header>

<div id="auth" class="card">
  <!-- שדה אימייל עם autocomplete אך ערך ריק בהתחלה -->
  <input id="email" placeholder="אימייל" autocomplete="on">
  <input id="password" placeholder="סיסמה" type="password">
  <button id="login">התחברות</button>
  <button id="register">הרשמה</button>
  <div id="authMessage" class="message"></div>
</div>

<div id="instructions" class="card" style="display:none;">
  <h2>ההוראה היומית:</h2>
  <p id="todayText" class="loading">טוען...</p>
  <button id="editBtn" style="display:none;">✏️ ערוך הוראה של היום</button>
  <button id="logout">התנתק</button>
  <div id="instructionMessage" class="message"></div>
</div>

<div id="adminPanel" class="card" style="display:none;">
  <h3>ניהול הוראות (אדמין בלבד)</h3>
  <input id="adminDate" type="date">
  <input id="adminText" placeholder="כתוב את ההוראה כאן">
  <button id="saveInstruction">💾 שמור הוראה</button>
  <div id="adminMessage" class="message"></div>
</div>

<!-- Modal לעריכה -->
<div id="editModal" class="modal">
  <div class="modal-content">
    <span class="close" id="closeModal">&times;</span>
    <h3>עריכת הוראה</h3>
    <textarea id="editText"></textarea>
    <button id="saveEdit">💾 שמור שינוי</button>
    <div id="editMessage" class="message"></div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBZHoP1FhaKBX0AcK7tc0g8uzpri9IIKsI",
  authDomain: "capital-market-app-ec814.firebaseapp.com",
  projectId: "capital-market-app-ec814",
  storageBucket: "capital-market-app-ec814.firebasestorage.app",
  messagingSenderId: "309964966513",
  appId: "1:309964966513:web:5efd82a505e7f0f58e29d0",
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const loginBtn = document.getElementById('login');
const registerBtn = document.getElementById('register');
const logoutBtn = document.getElementById('logout');
const editBtn = document.getElementById('editBtn');
const saveEditBtn = document.getElementById('saveEdit');
const closeModal = document.getElementById('closeModal');

const authMessage = document.getElementById('authMessage');
const instructionMessage = document.getElementById('instructionMessage');
const editMessage = document.getElementById('editMessage');
const adminMessage = document.getElementById('adminMessage');

const editModal = document.getElementById('editModal');
const editText = document.getElementById('editText');
const todayText = document.getElementById('todayText');
const adminPanel = document.getElementById('adminPanel');

// **שדה האימייל ריק בהתחלה – לא מכניסים ערך**
window.onload = () => {
  // אין כאן קוד שמכניס את savedEmail לשדה
};

// פונקציות להודעות
function showMessage(el, text, type='success') {
  el.innerText = text;
  el.className = `message ${type}`;
  el.style.display = 'block';
  setTimeout(()=>el.style.display='none', 4000);
}

// Login & Register
loginBtn.onclick = async () => {
  const email = document.getElementById('email').value.trim();
  const password = document.getElementById('password').value.trim();
  try {
    await signInWithEmailAndPassword(auth, email, password);
    localStorage.setItem("savedEmail", email); // נשמר לשימוש פנימי בלבד
  } catch(e){ showMessage(authMessage, "שגיאה בהתחברות: "+e.message,'error'); }
};

registerBtn.onclick = async () => {
  const email = document.getElementById('email').value.trim();
  const password = document.getElementById('password').value.trim();
  try {
    await createUserWithEmailAndPassword(auth, email, password);
    localStorage.setItem("savedEmail", email); // נשמר לשימוש פנימי בלבד
  } catch(e){ showMessage(authMessage, "שגיאה בהרשמה: "+e.message,'error'); }
};

// Logout
logoutBtn.onclick = async ()=> { await signOut(auth); location.reload(); };

// Helper: generate date string YYYY-MM-DD
function getTodayId(date=new Date()) {
  return `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
}

// Load today's instruction
async function loadInstruction() {
  todayText.innerText = 'טוען...';
  const docRef = doc(db, "instructions", getTodayId());
  const docSnap = await getDoc(docRef);
  todayText.innerText = docSnap.exists()? docSnap.data().text : "אין הוראה להיום.";
}

// Auth state change
onAuthStateChanged(auth, async user => {
  if(user){
    document.getElementById('auth').style.display = 'none';
    document.getElementById('instructions').style.display = 'block';
    await loadInstruction();

    // בדיקת אדמין לפי role
    const adminEmails = ["ilaybs2211@gmail.com"];
    if(adminEmails.includes(user.email)){
      adminPanel.style.display = 'block';
      editBtn.style.display = 'block';
    } else {
      adminPanel.style.display = 'none';
      editBtn.style.display = 'none';
    }

  } else {
    document.getElementById('auth').style.display = 'block';
    document.getElementById('instructions').style.display = 'none';
  }
});

// Admin: Save instruction
document.getElementById('saveInstruction').onclick = async ()=>{
  const date = document.getElementById('adminDate').value;
  const text = document.getElementById('adminText').value.trim();
  if(!date || !text){ showMessage(adminMessage,'מלא תאריך והוראה','error'); return; }

  try{
    await setDoc(doc(db,"instructions",date),{text});
    showMessage(adminMessage,'ההוראה נשמרה בהצלחה!','success');
    if(getTodayId()===date) await loadInstruction();
  } catch(e){ showMessage(adminMessage,'שגיאה: '+e.message,'error'); }
};

// Edit modal
editBtn.onclick = async ()=>{
  const docRef = doc(db, "instructions", getTodayId());
  const docSnap = await getDoc(docRef);
  editText.value = docSnap.exists()? docSnap.data().text : '';
  editModal.style.display = 'block';
};

// Close modal
closeModal.onclick = ()=> editModal.style.display='none';
window.onclick = (e)=>{ if(e.target===editModal) editModal.style.display='none'; };

// Save edit
saveEditBtn.onclick = async ()=>{
  const user = auth.currentUser;
  if(!user){ showMessage(editMessage,'רק אדמין יכול לשנות הוראה','error'); return; }

  const text = editText.value.trim();
  if(!text){ showMessage(editMessage,'ההוראה לא יכולה להיות ריקה','error'); return; }

  try{
    await setDoc(doc(db,"instructions",getTodayId()),{text});
    showMessage(editMessage,'ההוראה עודכנה בהצלחה!','success');
    await loadInstruction();
    editModal.style.display='none';
  } catch(e){ showMessage(editMessage,'שגיאה: '+e.message,'error'); }
};
</script>
</body>
</html>

